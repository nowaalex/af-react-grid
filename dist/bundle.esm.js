import t,{Children as e}from"react";import s from"prop-types";import{DraggableCore as i}from"react-draggable";import r from"react-dom";import o from"classnames";const n=t.memo(({className:e,type:s,style:r,index:o,onDrag:n,onStart:a,disabled:h,children:c})=>t.createElement(i,{onStart:a,onDrag:n,disabled:h},t.createElement("div",{"data-resizer-index":o,"data-resizer-type":s,className:e,style:r,children:c})));n.propTypes={type:s.oneOf(["row","col"]),onDrag:s.func,onStart:s.func,index:s.number,disabled:s.bool,children:s.node,style:s.object,className:s.string};const a="aFrCtGrD";class h{constructor(){const t=localStorage.getItem(a);this.t=t?JSON.parse(t):{},window.addEventListener("beforeunload",()=>{Object.keys(this.t).length>1&&localStorage.setItem(a,JSON.stringify(this.t))})}e(t,e){this.t[t]=e}s(t){return this.t[t]||{}}}var c=new h;const l=(t,e=Object.create(null))=>s=>e[s]||(e[s]=t(s)),m=(t,e,s)=>t>s?s:t<e?e:t,d={row:{i:"react-rsz-grid-row",r:"pageX",o:"offsetWidth",n:"clientWidth",a:"width",h:"minWidth",c:"maxWidth",l:["Left","Right"]},col:{i:"react-rsz-grid-col",r:"pageY",o:"offsetHeight",n:"clientHeight",a:"height",h:"minHeight",c:"maxHeight",l:["Top","Bottom"]}},p=(t,e,s)=>t.hasOwnProperty(e)?t[e]:s;function f(e){if(!t.isValidElement(e))return e;const{type:s,props:i}=e,{resizerChildren:r,type:o,localStorageKey:a}=this.props,h=p(this.props,"resizerClassName","react-rsz-grid-default-resizer"),c=this.m;if(s===n)return t.cloneElement(e,{index:c,onDrag:this.d,onStart:this.p,type:o,className:p(i,"className",h)},p(i,"children",r));const l=this.state[c],m={style:i.style?Object.assign({},i.style,l):l,ref:this.f(c)};return s===g&&(m.resizerClassName=p(i,"resizerClassName",h),m.resizerChildren=p(i,"resizerChildren",r),m.localStorageKey=p(i,"localStorageKey",a+"_"+c)),this.m++,t.cloneElement(e,m)}class g extends t.Component{constructor(...t){super(...t),this.state=c.s(this.props.localStorageKey),this.g=[],this.p=(t=>{const e=this.u=+t.currentTarget.dataset.resizerIndex,s=this.g[e-1],i=this.g[e];if(this.y=!(!s||!i)){const{r:e}=d[this.props.type];this.D=t[e],this.S(s,1),this.S(i,2);const r=this._curD1+this._curD2;this._maxD1||(this._maxD1=r-this._minD2),this._maxD2||(this._maxD2=r-this._minD1),this.N()}else"production"!==process.env.NODE_ENV&&console.warn("Resizer must be between other components. It is inactive during this drag.")}),this.d=(t=>{if(this.y){const{r:e,a:s}=d[this.props.type],i=t[e]-this.D;this.setState(t=>this.z(t,s,i))}}),this.f=l(t=>e=>{this.g[t]=r.findDOMNode(e),"production"===process.env.NODE_ENV||!this.g[t]||this.g[t]instanceof Element||__JEST__||console.error("af-react-grid: can't find ref for component:",e,"ReactDOM.findDomNode must return element for all children of Container.")}),this.w=((t,{type:e})=>{const{a:s,o:i}=d[e];return this.g.reduce((e,r,o)=>(r&&(e[o]=Object.assign({},t[o],{[s]:r[i],flexBasis:"auto",boxSizing:"border-box"})),e),{})}),this.N=(()=>this.setState(this.w))}S(t,e){const{type:s}=this.props,{c:i,h:r,o,n,l:a}=d[s],h=getComputedStyle(t),c=(this["_curD"+e]=t[o])-t[n]+a.reduce((t,e)=>t+parseFloat(h[`padding${e}`]),0);this["_minD"+e]=c+(parseFloat(h[r])||0),this["_maxD"+e]=parseFloat(h[i])||0}b(){const{localStorageKey:t}=this.props;t&&c.e(t,this.state)}z(t,e,s){const i=this.u;return{[i-1]:Object.assign({},t[i-1],{[e]:m(this._curD1+s,this._minD1,this._maxD1)}),[i]:Object.assign({},t[i],{[e]:m(this._curD2-s,this._minD2,this._maxD2)})}}render(){const{type:s,className:i,children:r,style:n}=this.props;return this.m=0,t.createElement("div",{style:n,className:o(i,d[s].i),children:e.map(r,f,this)})}componentDidMount(){this._st=setTimeout(this.N,50),window.addEventListener("resize",this.N)}componentDidUpdate(){this.b();const t=this.g.length-this.m;t&&this.g.splice(this.m,t)}componentWillUnmount(){window.removeEventListener("resize",this.N),clearTimeout(this._st)}}g.propTypes={type:s.oneOf(["row","col"]),className:s.string,style:s.object,children:(s,i)=>{if(e.toArray(s[i]).some(e=>t.isValidElement(e)&&(e.type===t.Fragment||Array.isArray(e))))throw new Error("Fragments and arrays are not allowed inside Container")},resizerChildren:s.node,resizerClassName:s.string,localStorageKey:s.string},g.defaultProps={type:"row"};export{n as Resizer,g as Container};
